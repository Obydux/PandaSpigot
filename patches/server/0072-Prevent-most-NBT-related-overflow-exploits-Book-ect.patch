From 0000000000000000000000000000000000000000 Mon Sep 17 00:00:00 2001
From: bob7l <idk@gmail.com>
Date: Sun, 6 Nov 2022 13:29:32 -0300
Subject: [PATCH] Prevent most NBT related overflow exploits (Book/ect)

For whatever reason, everyone always implements hacky checks to detect NBT overflow exploits. It's pointless, and makes you look like a fool. This default number, 2097152L, puts an INSANE ~2MB limit on NBT which shouldn't ever be possible unless your server has HUGE books. This commit changes that limit to ~0.05MB in the most efficient way possible. If the cap is hit during reading, a RuntimeException is thrown and the connection is immediately closed.

Usually I put this at 10,000, but for the sake of others I've increased it to 50,000. It would be wise to make this configurable as I'm sure some servers may use very very large items, or books. For the majority of server types however, this highly reduced limit should be perfect.

I would still advise there to be strict limits put on incoming packets. Usually I limit packets to 1k per second to account for lag since the timeout time is 30 seconds hardcoded. But that's for another commit.

diff --git a/src/main/java/com/hpfxd/pandaspigot/config/PandaSpigotConfig.java b/src/main/java/com/hpfxd/pandaspigot/config/PandaSpigotConfig.java
index 800b9970bd15ee6d1357ab2e27e963607449b915..f419b852012b8994ef870368ed63fb2d9f38d73b 100644
--- a/src/main/java/com/hpfxd/pandaspigot/config/PandaSpigotConfig.java
+++ b/src/main/java/com/hpfxd/pandaspigot/config/PandaSpigotConfig.java
@@ -127,4 +127,7 @@ public class PandaSpigotConfig {
     public boolean logPlayerIpAddresses = true;
 
     public boolean disableDisconnectSpam = false;
+
+    @Comment("That default number, 2097152L, puts an INSANE ~2MB limit on NBT. We changed the limit to ~0.05 MB.")
+    public long nbtReadLimiter = 50000L;
 }
diff --git a/src/main/java/net/minecraft/server/PacketDataSerializer.java b/src/main/java/net/minecraft/server/PacketDataSerializer.java
index ad33280bb8baab581a4ac17b5fe78022134c676b..acd207abf75c770b1a5dd1aa62ed68f7d4847c00 100644
--- a/src/main/java/net/minecraft/server/PacketDataSerializer.java
+++ b/src/main/java/net/minecraft/server/PacketDataSerializer.java
@@ -167,7 +167,7 @@ public class PacketDataSerializer extends ByteBuf {
             return null;
         } else {
             this.readerIndex(i);
-            return NBTCompressedStreamTools.a((DataInput) (new ByteBufInputStream(this)), new NBTReadLimiter(2097152L));
+            return NBTCompressedStreamTools.a((DataInput) (new ByteBufInputStream(this)), new NBTReadLimiter(com.hpfxd.pandaspigot.config.PandaSpigotConfig.get().nbtReadLimiter)); // PandaSpigot - Reduce default value and make configurable
         }
     }
 
